---
title: "Dataset1_separate"
format: html
editor: visual
---

```{r}
# Setup
library(GEOquery)
library(limma)
library(WGCNA)
library(nlme)
library(dplyr)

options(stringsAsFactors = FALSE)
disableWGCNAThreads()

# Load data
gse   <- getGEO("GSE45238", GSEMatrix = TRUE)
eset  <- gse[[1]]

expr  <- exprs(eset)
pheno <- pData(eset)
annot <- fData(eset)

rownames(pheno) <- pheno$geo_accession
dim(expr); head(pheno); head(annot)

# Probe filtering
colnames(annot)
unique(annot$miRNA_version)

is_mature_v12 <- annot$TargetMatureVersion == 12
is_control <- grepl("control|spike|U6|snoR", annot$SYMBOL, ignore.case = TRUE)

keep_probes <- is_mature_v12 & !is_control
expr  <- expr[keep_probes, ]
annot <- annot[keep_probes, ]

dim(expr)
head(annot)

# Normalization
expr_log2 <- log2(expr + 1)
expr_norm <- normalizeBetweenArrays(expr_log2, method = "quantile")

rownames(expr_norm) <- rownames(expr)
colnames(expr_norm) <- colnames(expr)

# QC: PCA + sample clustering
op <- par(mar = c(5, 4, 4, 10), xpd = TRUE)

expr_t <- t(expr_norm)
pca <- prcomp(expr_t, scale. = TRUE)

sample_ids    <- colnames(expr_norm)
highlight_ids <- c("GSM1099641", "GSM1099655")
point_col     <- ifelse(sample_ids %in% highlight_ids, "red", "black")

plot(pca$x[,1], pca$x[,2],
     xlab = "PC1", ylab = "PC2",
     pch = 19,
     col = point_col,
     main = "PCA after normalization")

text(pca$x[,1], pca$x[,2],
     labels = sample_ids,
     pos = 3, cex = 0.6,
     col = point_col)

legend("topright",
       inset = c(-0.55, 0),
       legend = c("Other samples", "Outliers (to remove)"),
       col    = c("black", "red"),
       pch    = 19,
       bty    = "n")

par(op)

sampleTree <- hclust(dist(expr_t), method = "average")
plot(sampleTree, labels = colnames(expr_norm), cex = 0.6,
     main = "Sample clustering")
abline(h = 35, col = "red")

pdf("SampleClustering.pdf", width = 14, height = 10)
plot(sampleTree,
     labels = colnames(expr_norm),
     cex = 0.6,
     main = "Sample clustering dendrogram")
abline(h = 35, col = "red")
dev.off()

# Patient IDs + remove outlier pairs (order-safe)
pheno$patient_id <- sub(".*_(\\d+)[NT]$", "\\1", pheno$title)
pheno$patient_id <- as.character(pheno$patient_id)

outlier_samples <- c("GSM1099641", "GSM1099655")
outlier_patient_ids <- unique(pheno$patient_id[pheno$geo_accession %in% outlier_samples])

keep_ids <- pheno$geo_accession[!pheno$patient_id %in% outlier_patient_ids]

expr_norm <- expr_norm[, keep_ids]
pheno     <- pheno[keep_ids, ]

stopifnot(identical(colnames(expr_norm), rownames(pheno)))

dim(expr_norm)
table(pheno$patient_id)
```

```{r}
# Expression matrix + condition split
pheno$condition <- ifelse(grepl("T$", pheno$title), "tumor", "normal")

datExpr <- t(expr_norm)
dim(datExpr)

gsg <- goodSamplesGenes(datExpr, verbose = 3)
gsg$allOK

# Separate tumour vs normal matrices
stopifnot(identical(rownames(pheno), rownames(datExpr)))

datExpr_tumor  <- datExpr[pheno$condition == "tumor",  , drop = FALSE]
datExpr_normal <- datExpr[pheno$condition == "normal", , drop = FALSE]

dim(datExpr_tumor)
dim(datExpr_normal)

gsg_t <- goodSamplesGenes(datExpr_tumor,  verbose = 3)
gsg_n <- goodSamplesGenes(datExpr_normal, verbose = 3)
stopifnot(gsg_t$allOK, gsg_n$allOK)
```

```{r}
# Soft-threshold power per subset
powers <- 1:20

sft_tumor <- pickSoftThreshold(datExpr_tumor,
                               powerVector = powers,
                               networkType = "unsigned",
                               verbose = 5)

sft_normal <- pickSoftThreshold(datExpr_normal,
                                powerVector = powers,
                                networkType = "unsigned",
                                verbose = 5)

par(mfrow = c(2,2))

plot(sft_tumor$fitIndices[,1],
     -sign(sft_tumor$fitIndices[,3]) * sft_tumor$fitIndices[,2],
     xlab="Power", ylab="Scale-free R^2",
     type="n", main="Tumor: scale independence")
text(sft_tumor$fitIndices[,1],
     -sign(sft_tumor$fitIndices[,3]) * sft_tumor$fitIndices[,2],
     labels=powers, cex=0.8, col="red")
abline(h=0.9, col="red")

plot(sft_tumor$fitIndices[,1], sft_tumor$fitIndices[,5],
     xlab="Power", ylab="Mean connectivity",
     type="n", main="Tumor: mean connectivity")
text(sft_tumor$fitIndices[,1], sft_tumor$fitIndices[,5],
     labels=powers, cex=0.8, col="red")

plot(sft_normal$fitIndices[,1],
     -sign(sft_normal$fitIndices[,3]) * sft_normal$fitIndices[,2],
     xlab="Power", ylab="Scale-free R^2",
     type="n", main="Normal: scale independence")
text(sft_normal$fitIndices[,1],
     -sign(sft_normal$fitIndices[,3]) * sft_normal$fitIndices[,2],
     labels=powers, cex=0.8, col="red")
abline(h=0.9, col="red")

plot(sft_normal$fitIndices[,1], sft_normal$fitIndices[,5],
     xlab="Power", ylab="Mean connectivity",
     type="n", main="Normal: mean connectivity")
text(sft_normal$fitIndices[,1], sft_normal$fitIndices[,5],
     labels=powers, cex=0.8, col="red")

par(mfrow = c(1,1))

softPower_tumor  <- 4
softPower_normal <- 4
```

```{r}
# Helper: single-network WGCNA run (subset)
run_single_wgcna <- function(datExpr_subset,
                             softPower = 7,
                             minModuleSize = 30,
                             deepSplit = 2,
                             mergeCutHeight = 0.25,
                             networkType = "unsigned") {

  adjacency_mat <- adjacency(datExpr_subset,
                             power = softPower,
                             type  = networkType)

  TOM <- TOMsimilarity(adjacency_mat, TOMType = networkType)
  dissTOM <- 1 - TOM

  geneTree <- hclust(as.dist(dissTOM), method = "average")

  dynamicMods <- cutreeDynamic(
    dendro = geneTree,
    distM = dissTOM,
    deepSplit = deepSplit,
    pamRespectsDendro = FALSE,
    minClusterSize = minModuleSize
  )

  dynamicColors <- labels2colors(dynamicMods)

  MElist <- moduleEigengenes(datExpr_subset, colors = dynamicColors)
  MEs    <- orderMEs(MElist$eigengenes)

  merge <- mergeCloseModules(
    datExpr_subset,
    dynamicColors,
    cutHeight = mergeCutHeight,
    verbose = 0
  )

  moduleColors <- merge$colors
  MEs_merged   <- orderMEs(merge$newMEs)

  list(
    adjacency = adjacency_mat,
    TOM = TOM,
    dissTOM = dissTOM,
    geneTree = geneTree,
    dynamicColors = dynamicColors,
    moduleColors = moduleColors,
    MEs = MEs_merged
  )
}
```

```{r}
# Consensus WGCNA across tumour + normal
stopifnot(identical(colnames(datExpr_tumor), colnames(datExpr_normal)))

multiExpr_cons <- list(
  Tumor  = list(data = datExpr_tumor),
  Normal = list(data = datExpr_normal)
)

softPower_cons <- 7

consensus_net <- blockwiseConsensusModules(
  multiExpr_cons,
  power = softPower_cons,
  networkType = "unsigned",
  TOMType = "unsigned",
  minModuleSize = 30,
  deepSplit = 2,
  pamRespectsDendro = FALSE,
  mergeCutHeight = 0.25,
  numericLabels = FALSE,
  maxBlockSize = ncol(datExpr),
  saveTOMs = FALSE,
  verbose = 3
)

consensus_colors <- setNames(consensus_net$colors, colnames(datExpr_tumor))
stopifnot(identical(names(consensus_colors), colnames(datExpr_normal)))
table(consensus_colors)

ME_cons_tumor <- moduleEigengenes(datExpr_tumor, colors = consensus_colors)$eigengenes
ME_cons_tumor <- orderMEs(ME_cons_tumor)

ME_cons_normal <- moduleEigengenes(datExpr_normal, colors = consensus_colors)$eigengenes
ME_cons_normal <- orderMEs(ME_cons_normal)

head(ME_cons_tumor)
head(ME_cons_normal)
```

```{r}
# Paired LMM on consensus module eigengenes
pheno$tumour <- ifelse(pheno$condition == "tumor", 1, 0)
pheno$Age <- as.numeric(pheno[,"age:ch1"])
pheno$Stage_num <- as.numeric(factor(pheno[,"Stage:ch1"], levels = c("I","II","III","IVA")))

sampleTraits <- pheno[, c("patient_id", "tumour", "Age", "Stage_num")]
rownames(sampleTraits) <- rownames(pheno)

ME_cons_all <- moduleEigengenes(datExpr, colors = consensus_colors)$eigengenes
ME_cons_all <- orderMEs(ME_cons_all)

datLMM_cons <- cbind(sampleTraits[rownames(ME_cons_all), ],
                     as.data.frame(ME_cons_all))

modNames_cons <- colnames(ME_cons_all)

cons_lmm <- lapply(modNames_cons, function(mn) {
  form <- as.formula(paste(mn, "~ tumour + Age + Stage_num"))
  fit  <- lme(form,
              random = ~ 1 | patient_id,
              data   = datLMM_cons,
              na.action = na.omit,
              method = "REML")
  sm <- summary(fit)
  tumour_row <- sm$tTable["tumour", ]
  data.frame(
    module = mn,
    beta_tumour = tumour_row["Value"],
    t_tumour = tumour_row["t-value"],
    p_tumour = tumour_row["p-value"],
    row.names = NULL
  )
})

cons_lmm_df <- do.call(rbind, cons_lmm)
cons_lmm_df[order(cons_lmm_df$p_tumour), ]
```

```{r}
# Preservation of consensus modules across conditions
multiColor_cons <- list(
  Tumor  = consensus_colors,
  Normal = consensus_colors
)

set.seed(12345)

mp_cons <- modulePreservation(
  multiData = multiExpr_cons,
  multiColor = multiColor_cons,
  dataIsExpr = TRUE,
  networkType = "unsigned",
  referenceNetworks = c(1, 2),
  nPermutations = 200,
  randomSeed = 12345,
  verbose = 3,
  parallelCalculation = FALSE
)

save(mp_cons, file = "modulePreservation_consensusColors_expr.RData")

Z_tum_in_norm <- mp_cons$preservation$Z$ref.Tumor$inColumnsAlsoPresentIn.Normal
Z_norm_in_tum <- mp_cons$preservation$Z$ref.Normal$inColumnsAlsoPresentIn.Tumor

head(Z_tum_in_norm)
head(Z_norm_in_tum)
```

```{r}
# Separate networks (tumour and normal)
tumor_net  <- run_single_wgcna(datExpr_tumor,  softPower = softPower_tumor)
normal_net <- run_single_wgcna(datExpr_normal, softPower = softPower_normal)

tumor_colors  <- setNames(tumor_net$moduleColors,  colnames(datExpr_tumor))
normal_colors <- setNames(normal_net$moduleColors, colnames(datExpr_normal))

stopifnot(identical(names(tumor_colors),  colnames(datExpr_tumor)))
stopifnot(identical(names(normal_colors), colnames(datExpr_normal)))

table(tumor_net$moduleColors)
table(normal_net$moduleColors)

plot(tumor_net$geneTree,  main = "Tumor miRNA clustering",  xlab = "", sub = "", cex = 0.4)
plot(normal_net$geneTree, main = "Normal miRNA clustering", xlab = "", sub = "", cex = 0.4)
```

```{r}
# Helper: extract preservation stats (Zsummary + medianRank)
extract_preservation <- function(mp_obj,
                                 ref = c("Tumor", "Normal"),
                                 test = c("Tumor", "Normal")) {
  ref  <- match.arg(ref)
  test <- match.arg(test)

  ref_key  <- paste0("ref.", ref)
  test_key <- paste0("inColumnsAlsoPresentIn.", test)

  zlist <- mp_obj$preservation$Z
  statsZ <- zlist[[ref_key]][[test_key]]

  if (is.null(statsZ)) {
    stop("Could not find Z preservation stats for: ", ref_key, " / ", test_key)
  }

  if ("gold" %in% rownames(statsZ)) {
    statsZ <- statsZ[rownames(statsZ) != "gold", , drop = FALSE]
  }

  zsum_col <- intersect(c("Zsummary.pres", "Zsummary"), colnames(statsZ))[1]
  if (is.na(zsum_col)) {
    stop("No Zsummary column found. Available columns: ",
         paste(colnames(statsZ), collapse = ", "))
  }

  Zsummary_pres <- statsZ[, zsum_col]

  medianRank_pres <- NULL
  obslist <- mp_obj$preservation$observed

  if (!is.null(obslist)) {
    statsO <- obslist[[ref_key]][[test_key]]

    if (!is.null(statsO) && "gold" %in% rownames(statsO)) {
      statsO <- statsO[rownames(statsO) != "gold", , drop = FALSE]
    }

    if (!is.null(statsO)) {
      mcol <- intersect(c("medianRank.pres", "medianRank"), colnames(statsO))[1]
      if (!is.na(mcol)) {
        medianRank_pres <- statsO[rownames(statsZ), mcol]
      }
    }
  }

  if (is.null(medianRank_pres)) {
    medianRank_pres <- rank(-Zsummary_pres, ties.method = "average")
  }

  out <- data.frame(
    module = rownames(statsZ),
    Zsummary_pres = as.numeric(Zsummary_pres),
    medianRank_pres = as.numeric(medianRank_pres),
    row.names = NULL
  )

  out[order(-out$Zsummary_pres), ]
}
```

```{r}
# Preservation stats: separate networks
multiExpr <- list(
  Tumor  = list(data = datExpr_tumor),
  Normal = list(data = datExpr_normal)
)

multiColor <- list(
  Tumor  = tumor_colors,
  Normal = normal_colors
)

set.seed(12345)

mp_expr <- modulePreservation(
  multiData = multiExpr,
  multiColor = multiColor,
  dataIsExpr = TRUE,
  networkType = "unsigned",
  referenceNetworks = c(1, 2),
  nPermutations = 200,
  randomSeed = 12345,
  verbose = 3,
  parallelCalculation = FALSE
)

save(mp_expr, file = "modulePreservation_expr.RData")

tumor_in_normal <- extract_preservation(mp_expr, ref = "Tumor",  test = "Normal")
normal_in_tumor <- extract_preservation(mp_expr, ref = "Normal", test = "Tumor")

tumor_in_normal
normal_in_tumor
```

```{r}
# Dot plots: preservation Zsummary
plot(tumor_in_normal$Zsummary_pres,
     xaxt = "n", pch = 19,
     xlab = "Tumor modules",
     ylab = "Preservation Zsummary (in Normal)",
     main = "Tumor \u2192 Normal module preservation")

axis(1, at = seq_along(tumor_in_normal$module),
     labels = tumor_in_normal$module, las = 2, cex.axis = 0.7)

abline(h = 2,  col = "red",  lty = 2)
abline(h = 10, col = "blue", lty = 2)

legend("topright",
       legend = c("Zsummary = 2 (weak / not preserved)", "Zsummary = 10 (strongly preserved)"),
       col    = c("red", "blue"),
       lty    = 2,
       lwd    = 2,
       bty    = "n")

plot(normal_in_tumor$Zsummary_pres,
     xaxt = "n", pch = 19,
     xlab = "Normal modules",
     ylab = "Preservation Zsummary (in Tumour)",
     main = "Normal \u2192 Tumour module preservation")

axis(1, at = seq_along(normal_in_tumor$module),
     labels = normal_in_tumor$module, las = 2, cex.axis = 0.7)

abline(h = 2,  col = "red",  lty = 2)
abline(h = 10, col = "blue", lty = 2)

legend("topright",
       legend = c("Zsummary = 2 (weak / not preserved)", "Zsummary = 10 (strongly preserved)"),
       col    = c("red", "blue"),
       lty    = 2,
       lwd    = 2,
       bty    = "n")
```

```{r}
# Compare separate networks to paired WGCNA export (Li)
library(pheatmap)
library(mclust)
library(nlme)
library(dplyr)

paired <- readRDS("paired_wgcna_export.rds")

moduleColors_wgcna <- paired$moduleColors
TOM_wgcna          <- paired$TOM
lmm_results_wgcna  <- paired$lmm_results

stopifnot(!is.null(names(moduleColors_wgcna)))
stopifnot(!is.null(dimnames(TOM_wgcna)))

moduleColors_tumor  <- setNames(tumor_net$moduleColors,  colnames(datExpr_tumor))
moduleColors_normal <- setNames(normal_net$moduleColors, colnames(datExpr_normal))

TOM_tumor  <- tumor_net$TOM
TOM_normal <- normal_net$TOM

miRNAs <- colnames(datExpr)
dimnames(TOM_wgcna)  <- list(miRNAs, miRNAs)
dimnames(TOM_tumor)  <- list(miRNAs, miRNAs)
dimnames(TOM_normal) <- list(miRNAs, miRNAs)

compare_module_overlap <- function(colors_A, colors_B,
                                   name_A = "A", name_B = "B",
                                   cluster_rows = TRUE, cluster_cols = TRUE) {
  common <- intersect(names(colors_A), names(colors_B))
  stopifnot(length(common) > 0)

  ca <- colors_A[common]
  cb <- colors_B[common]

  tab <- table(A = ca, B = cb)

  a_sizes <- rowSums(tab)
  b_sizes <- colSums(tab)

  rownames(tab) <- paste0(rownames(tab), " (n=", a_sizes, ")")
  colnames(tab) <- paste0(colnames(tab), " (n=", b_sizes, ")")

  pheatmap::pheatmap(
    tab,
    cluster_rows = cluster_rows,
    cluster_cols = cluster_cols,
    main = paste0("Module overlap: ", name_A, " vs ", name_B),
    display_numbers = tab,
    number_format  = "%.0f",
    fontsize_number = 8
  )

  ari <- mclust::adjustedRandIndex(as.integer(factor(ca)),
                                   as.integer(factor(cb)))

  cat("\nARI(", name_A, " vs ", name_B, ") =", ari, "\n")
  invisible(list(tab = tab, ari = ari, common = common))
}

compare_edge_weights <- function(TOM_A, TOM_B, miRNA_ids,
                                 name_A = "A", name_B = "B") {
  common <- intersect(rownames(TOM_A), rownames(TOM_B))
  common <- intersect(common, miRNA_ids)
  stopifnot(length(common) > 0)

  A <- TOM_A[common, common]
  B <- TOM_B[common, common]

  v1 <- A[upper.tri(A)]
  v2 <- B[upper.tri(B)]

  test <- cor.test(v1, v2, method = "spearman")

  print(test)
  plot(v1, v2, pch = 20,
       xlab = paste0(name_A, " TOM edge weight"),
       ylab = paste0(name_B, " TOM edge weight"),
       main = paste0("Edge-weight agreement (TOM): ", name_A, " vs ", name_B))

  cat("\nSpearman rho =", unname(test$estimate),
      " | p =", test$p.value, "\n")

  invisible(test)
}

compare_hubs <- function(TOM_A, TOM_B, miRNA_ids,
                         name_A = "A", name_B = "B",
                         topK = c(25, 50, 75, 100)) {
  common <- intersect(rownames(TOM_A), rownames(TOM_B))
  common <- intersect(common, miRNA_ids)
  stopifnot(length(common) > 0)

  A <- TOM_A[common, common]
  B <- TOM_B[common, common]

  kA <- rowSums(A) - diag(A)
  kB <- rowSums(B) - diag(B)

  test <- cor.test(kA, kB, method = "spearman")
  print(test)

  cat("\nTop-hub overlap (", name_A, " vs ", name_B, ")\n", sep = "")
  for (K in topK) {
    hubsA <- names(sort(kA, decreasing = TRUE))[1:K]
    hubsB <- names(sort(kB, decreasing = TRUE))[1:K]
    n_ol  <- length(intersect(hubsA, hubsB))
    cat("  K =", K, ": overlap =", n_ol,
        " (", round(100 * n_ol / K, 1), "%)\n", sep = "")
  }

  invisible(list(test = test, kA = kA, kB = kB))
}

fit_module_lmm <- function(MEs_mat, sampleTraits_df) {
  dat <- cbind(sampleTraits_df[rownames(MEs_mat), ], as.data.frame(MEs_mat))
  mods <- colnames(MEs_mat)

  res <- lapply(mods, function(mn) {
    form <- as.formula(paste(mn, "~ tumour + Age + Stage_num"))
    fit  <- lme(form, random = ~ 1 | patient_id, data = dat,
                na.action = na.omit, method = "REML")
    sm <- summary(fit)
    tumour_row <- sm$tTable["tumour", ]
    data.frame(
      module = mn,
      beta_tumour = tumour_row["Value"],
      t_tumour = tumour_row["t-value"],
      p_tumour = tumour_row["p-value"],
      row.names = NULL
    )
  })

  out <- do.call(rbind, res)
  out$FDR <- p.adjust(out$p_tumour, method = "BH")
  out[order(out$FDR), ]
}

stopifnot(all(c("patient_id","tumour","Age","Stage_num") %in% colnames(sampleTraits)))
stopifnot(identical(rownames(sampleTraits), rownames(datExpr)))

ME_tumor_all  <- moduleEigengenes(datExpr, colors = moduleColors_tumor)$eigengenes
ME_tumor_all  <- orderMEs(ME_tumor_all)

ME_normal_all <- moduleEigengenes(datExpr, colors = moduleColors_normal)$eigengenes
ME_normal_all <- orderMEs(ME_normal_all)

lmm_tumor_modules  <- fit_module_lmm(ME_tumor_all,  sampleTraits)
lmm_normal_modules <- fit_module_lmm(ME_normal_all, sampleTraits)

top_wgcna_me    <- lmm_results_wgcna$module[order(lmm_results_wgcna$p_tumour)][1]
top_wgcna_color <- sub("^ME", "", top_wgcna_me)

top_tumor_me    <- lmm_tumor_modules$module[1]
top_tumor_color <- sub("^ME", "", top_tumor_me)

top_normal_me    <- lmm_normal_modules$module[1]
top_normal_color <- sub("^ME", "", top_normal_me)

cat("\nTop modules (by FDR/p):\n")
cat("  Paired WGCNA:", top_wgcna_me, "\n")
cat("  Tumor-net   :", top_tumor_me, "\n")
cat("  Normal-net  :", top_normal_me, "\n\n")

jaccard_set <- function(a, b) length(intersect(a,b)) / length(union(a,b))

genes_w <- names(moduleColors_wgcna)[moduleColors_wgcna == top_wgcna_color]
genes_t <- names(moduleColors_tumor)[moduleColors_tumor == top_tumor_color]
genes_n <- names(moduleColors_normal)[moduleColors_normal == top_normal_color]

cat("Jaccard (Paired top vs Tumor top)  =", jaccard_set(genes_w, genes_t), "\n")
cat("Jaccard (Paired top vs Normal top) =", jaccard_set(genes_w, genes_n), "\n")

ov_w_t <- compare_module_overlap(moduleColors_wgcna, moduleColors_tumor,
                                 name_A = "Paired WGCNA", name_B = "Tumor network")

ov_w_n <- compare_module_overlap(moduleColors_wgcna, moduleColors_normal,
                                 name_A = "Paired WGCNA", name_B = "Normal network")

ov_t_n <- compare_module_overlap(moduleColors_tumor, moduleColors_normal,
                                 name_A = "Tumor network", name_B = "Normal network")

ew_w_t <- compare_edge_weights(TOM_wgcna, TOM_tumor, miRNAs,
                               name_A = "Paired WGCNA", name_B = "Tumor network")

ew_w_n <- compare_edge_weights(TOM_wgcna, TOM_normal, miRNAs,
                               name_A = "Paired WGCNA", name_B = "Normal network")

ew_t_n <- compare_edge_weights(TOM_tumor, TOM_normal, miRNAs,
                               name_A = "Tumor network", name_B = "Normal network")

hb_w_t <- compare_hubs(TOM_wgcna, TOM_tumor, miRNAs,
                       name_A = "Paired WGCNA", name_B = "Tumor network")

hb_w_n <- compare_hubs(TOM_wgcna, TOM_normal, miRNAs,
                       name_A = "Paired WGCNA", name_B = "Normal network")

hb_t_n <- compare_hubs(TOM_tumor, TOM_normal, miRNAs,
                       name_A = "Tumor network", name_B = "Normal network")

common_h <- intersect(rownames(TOM_tumor), rownames(TOM_normal))
common_h <- intersect(common_h, miRNAs)

A <- TOM_tumor[common_h, common_h]
B <- TOM_normal[common_h, common_h]

k_t <- rowSums(A) - diag(A)
k_n <- rowSums(B) - diag(B)

plot(k_t, k_n, pch = 20,
     xlab = "Tumor node strength (sum TOM)",
     ylab = "Normal node strength (sum TOM)",
     main = "Hub-strength agreement: Tumor vs Normal")
abline(lm(k_n ~ k_t), lty = 2)
```
