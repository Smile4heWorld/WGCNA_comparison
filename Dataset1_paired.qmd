---
title: "Dataset1_paired"
format: html
editor: visual
---

```{r}
# Setup
library(GEOquery)
library(limma)
library(WGCNA)
library(iCheck)
library(nlme)
library(dplyr)

options(stringsAsFactors = FALSE)
disableWGCNAThreads()

# Load data
gse   <- getGEO("GSE45238", GSEMatrix = TRUE)
eset  <- gse[[1]]

expr  <- exprs(eset)
pheno <- pData(eset)
annot <- fData(eset)

rownames(pheno) <- pheno$geo_accession
dim(expr); head(pheno); head(annot)

# Probe filtering
colnames(annot)
unique(annot$miRNA_version)

is_mature_v12 <- annot$TargetMatureVersion == 12
is_control <- grepl("control|spike|U6|snoR", annot$SYMBOL, ignore.case = TRUE)

keep_probes <- is_mature_v12 & !is_control
expr  <- expr[keep_probes, ]
annot <- annot[keep_probes, ]

dim(expr)
head(annot)

# Normalization
expr_log2 <- log2(expr + 1)
expr_norm <- normalizeBetweenArrays(expr_log2, method = "quantile")

rownames(expr_norm) <- rownames(expr)
colnames(expr_norm) <- colnames(expr)

# QC: PCA + sample clustering (label only outliers in dendrogram)
op <- par(mar = c(5, 4, 4, 10), xpd = TRUE)

expr_t <- t(expr_norm)
pca <- prcomp(expr_t, scale. = TRUE)

sample_ids    <- colnames(expr_norm)
highlight_ids <- c("GSM1099641", "GSM1099655")
point_col     <- ifelse(sample_ids %in% highlight_ids, "red", "black")

plot(pca$x[,1], pca$x[,2],
     xlab = "PC1", ylab = "PC2",
     pch = 19,
     col = point_col,
     main = "PCA after normalization")

text(pca$x[,1], pca$x[,2],
     labels = sample_ids,
     pos = 3, cex = 0.6,
     col = point_col)

legend("topright",
       inset = c(-0.55, 0),
       legend = c("Other samples", "Outliers (to remove)"),
       col    = c("black", "red"),
       pch    = 19,
       bty    = "n")

par(op)

sampleTree <- hclust(dist(expr_t), method = "average")

outliers <- highlight_ids
leaf_order <- sampleTree$labels[sampleTree$order]
out_pos <- match(outliers, leaf_order)

op <- par(mar = c(12, 4, 4, 2) + 0.1, xpd = NA)
plot(sampleTree, labels = FALSE, xaxt = "n",
     main = "Sample clustering dendrogram", xlab = "", sub = "")
abline(h = 35, col = "red")

for (i in seq_along(outliers)) {
  axis(1, at = out_pos[i], labels = outliers[i],
       tick = TRUE, line = -20, las = 2, cex.axis = 1.2, col.axis = "red")
}
par(op)

pdf("SampleClustering.pdf", width = 14, height = 10)
op <- par(mar = c(12, 4, 4, 2) + 0.1, xpd = NA)
plot(sampleTree, labels = FALSE, xaxt = "n",
     main = "Sample clustering dendrogram", xlab = "", sub = "")
abline(h = 35, col = "red")

for (i in seq_along(outliers)) {
  axis(1, at = out_pos[i], labels = outliers[i],
       tick = FALSE, line = -22, las = 2, cex.axis = 1, col.axis = "red")
}
par(op)
dev.off()

# Patient IDs + remove outlier pairs
pheno$patient_id <- sub(".*_(\\d+)[NT]$", "\\1", pheno$title)
pheno$patient_id <- as.character(pheno$patient_id)

outlier_samples <- c("GSM1099641", "GSM1099655")
outlier_patient_ids <- unique(pheno$patient_id[pheno$geo_accession %in% outlier_samples])

keep_samples <- !pheno$patient_id %in% outlier_patient_ids

expr_norm <- expr_norm[, keep_samples]
pheno     <- pheno[keep_samples, ]

dim(expr_norm)
table(pheno$patient_id)
```

```{r}
# Li et al. pipeline: WGCNA on all samples (no Δ)
pheno$condition <- ifelse(grepl("T$", pheno$title), "tumor", "normal")

datExpr <- t(expr_norm)   # samples × miRNAs
dim(datExpr)

gsg <- goodSamplesGenes(datExpr, verbose = 3)
gsg$allOK

# Soft-threshold selection (unsigned; Li)
powers <- 1:20
sft <- pickSoftThreshold(datExpr,
                         powerVector = powers,
                         networkType = "unsigned",
                         verbose = 5)

par(mfrow = c(1,2))
plot(sft$fitIndices[,1],
     -sign(sft$fitIndices[,3]) * sft$fitIndices[,2],
     xlab = "Soft Threshold (power)",
     ylab = "Scale Free Topology Model Fit, signed R^2",
     type = "n",
     main = "Scale independence")
text(sft$fitIndices[,1],
     -sign(sft$fitIndices[,3]) * sft$fitIndices[,2],
     labels = powers, cex = 0.8, col = "red")
abline(h = 0.97, col = "red")

plot(sft$fitIndices[,1],
     sft$fitIndices[,5],
     xlab = "Soft Threshold (power)",
     ylab = "Mean Connectivity",
     type = "n",
     main = "Mean connectivity")
text(sft$fitIndices[,1],
     sft$fitIndices[,5],
     labels = powers, cex = 0.8, col = "red")

softPower <- 7
softPower
```

```{r}
# Network construction (unsigned)
adjacency <- adjacency(datExpr, power = softPower, type = "unsigned")
TOM     <- TOMsimilarity(adjacency, TOMType = "unsigned")
dissTOM <- 1 - TOM

geneTree <- hclust(as.dist(dissTOM), method = "average")
plot(geneTree,
     main = "Clustering of miRNAs based on TOM (unsigned, Li pipeline)",
     xlab = "", sub = "", cex = 0.4)

# Module detection + merging
minModuleSize <- 30

dynamicMods <- cutreeDynamic(
  dendro = geneTree,
  distM = dissTOM,
  deepSplit = 2,
  pamRespectsDendro = FALSE,
  minClusterSize = minModuleSize
)

dynamicColors <- labels2colors(dynamicMods)
table(dynamicColors)

plotDendroAndColors(
  geneTree,
  dynamicColors,
  "Dynamic Tree Cut",
  dendroLabels = FALSE,
  hang = 0.03,
  addGuide = TRUE,
  guideHang = 0.05,
  main = "miRNA dendrogram and module colors (Li pipeline)"
)

moduleColors0 <- dynamicColors

MElist <- moduleEigengenes(datExpr, colors = moduleColors0)
MEs    <- orderMEs(MElist$eigengenes)

MEDiss <- 1 - cor(MEs)
METree <- hclust(as.dist(MEDiss), method = "average")

mergeCutHeight <- 0.25

plot(METree,
     main = "Clustering of module eigengenes (before merging)",
     xlab = "", sub = "")
abline(h = mergeCutHeight, col = "red")

merge <- mergeCloseModules(
  datExpr,
  moduleColors0,
  cutHeight = mergeCutHeight,
  verbose = 3
)

moduleColors <- merge$colors
MEs          <- orderMEs(merge$newMEs)

plotDendroAndColors(
  geneTree,
  cbind(moduleColors0, moduleColors),
  c("Dynamic Tree Cut", "Merged modules"),
  dendroLabels = FALSE,
  hang = 0.03,
  addGuide = TRUE,
  guideHang = 0.05,
  main = "Modules before and after merging"
)

table(moduleColors)
```

```{r}
# Sample-level traits for LMM
stopifnot(identical(rownames(pheno), rownames(datExpr)))

pheno$tumour <- ifelse(pheno$condition == "tumor", 1, 0)
pheno$Age <- as.numeric(pheno[,"age:ch1"])
pheno$Stage_num <- as.numeric(factor(pheno[,"Stage:ch1"], levels = c("I","II","III","IVA")))

sampleTraits <- pheno[, c("patient_id", "tumour", "Age", "Stage_num")]
rownames(sampleTraits) <- rownames(pheno)

identical(rownames(sampleTraits), rownames(datExpr))

# LMM on module eigengenes
datLMM <- cbind(sampleTraits[rownames(MEs), ],
                as.data.frame(MEs))

modNames <- colnames(MEs)

lmm_results <- lapply(modNames, function(mn) {
  form <- as.formula(paste(mn, "~ tumour + Age + Stage_num"))

  fit <- lme(form,
             random = ~ 1 | patient_id,
             data   = datLMM,
             na.action = na.omit,
             method = "REML")

  sm <- summary(fit)
  tumour_row <- sm$tTable["tumour", ]

  data.frame(
    module      = mn,
    beta_tumour = round(tumour_row["Value"], 2),
    t_tumour    = round(tumour_row["t-value"], 2),
    p_tumour    = formatC(as.numeric(tumour_row["p-value"]), format = "e", digits = 2),
    row.names   = NULL
  )
})

lmm_results_df <- do.call(rbind, lmm_results)
lmm_results_df[order(abs(lmm_results_df$t_tumour), decreasing = TRUE), c(1,2,3,4)]
```

```{r}
# Heatmap of tumour t-values
lmm_results_df$module_clean <- substring(lmm_results_df$module, 3)

tmat <- matrix(lmm_results_df$t_tumour,
               nrow = nrow(lmm_results_df),
               dimnames = list(lmm_results_df$module_clean, "Tumour (t)"))

pheatmap::pheatmap(tmat,
                   main = "Module–tumour associations (LMM t-values)",
                   cluster_rows = FALSE,
                   cluster_cols = FALSE,
                   display_numbers = round(tmat, 2))

# Gene significance (GS) via per-miRNA LMM t-stat
expr_forGS <- datExpr

datGS <- cbind(sampleTraits[rownames(expr_forGS), ],
               as.data.frame(expr_forGS))

miRNAs <- colnames(expr_forGS)

gs_list <- lapply(miRNAs, function(g) {
  form <- as.formula(paste(g, "~ tumour + Age + Stage_num"))
  fit  <- lme(form,
              random = ~ 1 | patient_id,
              data   = datGS,
              na.action = na.omit,
              method = "REML")
  sm <- summary(fit)
  t_tumour <- sm$tTable["tumour","t-value"]
  data.frame(miRNA = g, GS = abs(t_tumour), row.names = NULL)
})

geneGS <- do.call(rbind, gs_list)
rownames(geneGS) <- geneGS$miRNA
```

```{r}
# Module membership (MM) + hub table
modNames_clean <- substring(colnames(MEs), 3)

geneModuleMembership <- as.data.frame(cor(datExpr, MEs, use = "p"))
colnames(geneModuleMembership) <- paste0("MM", modNames_clean)
rownames(geneModuleMembership) <- colnames(datExpr)

hubData <- data.frame(
  miRNA  = colnames(datExpr),
  module = moduleColors,
  geneModuleMembership,
  GS     = geneGS[colnames(datExpr), "GS"],
  row.names = NULL
)

# Intramodular connectivity + top hubs
IMConn <- intramodularConnectivity(adjacency, moduleColors)
IMConn_df <- as.data.frame(IMConn)
IMConn_df$miRNA <- rownames(IMConn_df)

hubData <- hubData %>%
  left_join(IMConn_df[, c("miRNA", "kWithin")], by = "miRNA")

hubList <- hubData %>%
  group_by(module) %>%
  arrange(desc(kWithin)) %>%
  slice_head(n = 10) %>%
  ungroup()

hubList
```

```{r}
# Example plot: GS vs MM in turquoise
targetModule <- "turquoise"
inMod <- hubData$module == targetModule

plot(hubData$MMturquoise[inMod],
     hubData$GS[inMod],
     xlab = "Module membership (turquoise)",
     ylab = "Gene significance (|t| for tumour)",
     main = paste("GS vs MM in", targetModule, "module"))
abline(lm(GS ~ MMturquoise, data = hubData[inMod, ]), lty = 2)

# Export module lists + top-10 hubs
moduleGenes <- split(hubData$miRNA, hubData$module)

for (mod in names(moduleGenes)) {
  write.table(moduleGenes[[mod]],
              file = paste0("module_", mod, "_miRNAs.txt"),
              row.names = FALSE,
              col.names = FALSE,
              quote = FALSE)
}

for (mod in unique(hubList$module)) {
  sub <- hubList[hubList$module == mod, ]
  write.table(sub,
              file = paste0("module_", mod, "_top10_hubs.txt"),
              row.names = FALSE,
              quote = FALSE,
              sep = "\t")
}

table(moduleColors)
```

```{r}
# Export adjacency + export full paired-WGCNA object
dimnames(adjacency) <- list(colnames(datExpr), colnames(datExpr))
saveRDS(adjacency, file = "paired_adjacency_matrix.rds")

adj_thresh <- 0.10
idx <- which(adjacency > adj_thresh & upper.tri(adjacency), arr.ind = TRUE)

adj_edge_list <- data.frame(
  gene1 = rownames(adjacency)[idx[,1]],
  gene2 = colnames(adjacency)[idx[,2]],
  adjacency = adjacency[idx]
)

write.table(adj_edge_list,
            file = "paired_adjacency_edges_thresh0.10.tsv",
            sep = "\t", quote = FALSE, row.names = FALSE)

moduleColors_paired <- moduleColors
TOM_paired          <- TOM
MEs_paired          <- MEs
hubData_paired      <- hubData
lmm_results_paired  <- lmm_results_df

names(moduleColors_paired) <- colnames(datExpr)
dimnames(TOM_paired) <- list(colnames(datExpr), colnames(datExpr))
rownames(hubData_paired) <- hubData_paired$miRNA

paired_wgcna_export <- list(
  method = "paired_WGCNA_Li_pipeline",
  date   = Sys.Date(),
  softPower = softPower,
  networkType = "unsigned",
  miRNAs = colnames(datExpr),
  moduleColors = moduleColors_paired,
  adjacency    = adjacency,
  TOM          = TOM_paired,
  MEs          = MEs_paired,
  hubData      = hubData_paired,
  lmm_results  = lmm_results_paired
)

saveRDS(paired_wgcna_export, file = "paired_wgcna_export.rds")

# Module sizes table
mod_sizes <- sort(table(moduleColors_paired), decreasing = TRUE)

modules_df <- data.frame(
  Module  = names(mod_sizes),
  Number_of_Genes = as.integer(mod_sizes),
  Relative_Amount = round(100 * as.integer(mod_sizes) / length(moduleColors_paired), 1),
  row.names = NULL
)

modules_df
```

```{r}
# Top 10 turquoise by kWithin (with MM + GS)
top10_turquoise <- hubData %>%
  filter(module == "turquoise") %>%
  arrange(desc(kWithin)) %>%
  transmute(
    miRNA,
    module,
    kWithin = round(kWithin, 2),
    MMturquoise = round(MMturquoise, 3),
    GS = round(GS, 3)
  ) %>%
  slice_head(n = 10)

top10_turquoise
```
